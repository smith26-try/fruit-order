<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
<meta name="theme-color" content="#0b72ff">
<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="icon-192.png">
<link rel="icon" type="image/png" href="icon-192.png">
<title>‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå ‚Ä¢ ‡∏ú‡∏•‡πÑ‡∏°‡πâ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≤‡∏ô</title>
<style>
:root{--brand:#0b72ff;--brand-ink:#fff;--bg:#f6f7f9;--card:#fff;--ink:#101828;--muted:#667085;--line:#e1e6eb;--ok:#0a7f53;}
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{height:100%;}
body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans Thai",sans-serif;}
.appbar{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;background:var(--card);padding:0 16px;min-height:64px;border-bottom:1px solid var(--line);}
.appbar .title{font-size:18px;font-weight:800;}
.container{padding:12px 16px 120px;max-width:920px;margin:0 auto;}
.group{margin-bottom:12px;}
.label{font-size:13px;color:var(--muted);margin:8px 0 6px;font-weight:700;text-transform:uppercase;}
.card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px;box-shadow:0 1px 2px rgba(0,0,0,.03);}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
@media(max-width:640px){.grid2{grid-template-columns:1fr;}}
input,textarea,select{width:100%;border:1px solid #dfe3e6;border-radius:12px;padding:14px 12px;font-size:16px;outline:none;background:#fff;}
textarea{min-height:88px;resize:vertical;}
.product-list{display:grid;gap:10px;}
.product{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center;padding:10px 12px;border:1px solid #eef1f4;border-radius:14px;background:#fff;}
.product .name{font-weight:700;}
.price{color:var(--ok);font-weight:800;min-width:64px;text-align:right;}
.step{display:flex;align-items:center;justify-content:center;gap:8px;border:1px solid #e1e6ec;border-radius:999px;padding:4px;background:#fff;}
.step button{width:36px;height:36px;border-radius:999px;border:none;cursor:pointer;background:#eef2f7;display:flex;align-items:center;justify-content:center;font-size:20px;line-height:1;padding:0;}
.step input{width:56px;height:36px;border:none;text-align:center;font-size:16px;padding:0;-webkit-appearance:none;appearance:none;}
.subtotal{color:#0a7;font-weight:800;min-width:96px;text-align:right;font-variant-numeric:tabular-nums;}
/* ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡πà‡∏≠‡∏¢‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß */
.option-group{margin-top:8px;display:grid;gap:6px;max-width:280px}
.option-item{display:flex;align-items:center;gap:8px}
.option-item label{min-width:92px;font-size:14px;color:#334155}
.option-item .step input{width:64px}

/* ===== Section ‡πÄ‡∏£‡∏ó‡∏û‡∏¥‡πÄ‡∏®‡∏© (‡∏û‡∏±‡∏ö/‡∏Ç‡∏¢‡∏≤‡∏¢‡πÑ‡∏î‡πâ) ===== */
.special-toggle{
  background:#fff7d6;
  border:2px solid #f59e0b;
  border-radius:12px;
  padding:10px 12px;
  margin-top:18px;
  font-size:16px;
  font-weight:700;
  color:#8a4b00;
  display:flex;
  align-items:center;
  justify-content:space-between;
  cursor:pointer;
}
.special-toggle .title{letter-spacing:.02em}
.special-toggle .chev{transition:transform .2s; font-size:18px; line-height:1}
.special-collapsed .chev{transform:rotate(-90deg)}
.special-wrap{display:none; margin-top:8px}
.product.special{background:#fffaf0;border-color:#f7c66b;}
.product.special .name{font-weight:800;}
/* =========================================== */

.sheet{position:fixed;left:0;right:0;bottom:0;z-index:20;background:var(--card);border-top:1px solid var(--line);padding:10px 16px calc(14px + env(safe-area-inset-bottom));display:grid;grid-template-columns:1fr auto;gap:10px;align-items:center;}
.pill{background:#f0f3f6;border:1px solid #e1e6ec;padding:6px 10px;border-radius:999px;font-weight:800;}
.primary{background:var(--brand);color:var(--brand-ink);border:none;padding:14px 16px;border-radius:12px;font-weight:800;font-size:16px;cursor:pointer;min-width:160px;}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:70px;background:#111;color:#fff;padding:10px 14px;border-radius:999px;font-size:14px;opacity:0;transition:.2s;z-index:99999;pointer-events:none;}
.toast.show{opacity:1;}
.modal{position:fixed;inset:0;z-index:50;display:none;background:rgba(0,0,0,.3);}
.modal.open{display:grid;place-items:end center;}
.modal .panel{width:100%;max-width:920px;background:#fff;border-radius:16px 16px 0 0;padding:16px 16px calc(28px + env(safe-area-inset-bottom));border-top:1px solid #eaecef;}
.panel h2{margin:0 0 8px;font-size:18px;}
.panel textarea{width:100%;min-height:220px;font-family:ui-monospace,Menlo,Consolas,"SF Mono",monospace;}
.actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;}
.btn{padding:12px 14px;border-radius:12px;border:1px solid #d9dee6;background:#eef2f7;font-weight:700;cursor:pointer;}
.btn.danger{background:#fee2e2;border-color:#fecaca;color:#991b1b;}
</style>
</head>
<body>
  <div class="appbar"><div class="title">‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ù‡∏£‡∏±‡πà‡∏á üçàüë©üçä</div><div class="muted">Version 2.1 Beta</div></div>

  <div class="container">
    <div class="group card">
      <div class="grid2">
        <div>
          <div class="label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div>
          <input id="date" type="date">
        </div>

        <div>
          <div class="label">‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div>
          <input id="name" type="text" placeholder="‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ ‡∏Ñ‡∏∏‡∏ì">
        </div>

        <div>
          <div class="label">‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠</div>
          <!-- wrapper + dropdown ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ -->
          <div style="position:relative">
            <input id="phone" type="tel" inputmode="numeric" placeholder="095-XXX-XXXX">
            <div id="phone-suggestions" style="
              position:absolute;top:100%;left:0;right:0;
              background:#fff;border:1px solid #ccc;border-radius:8px;
              max-height:180px;overflow-y:auto;display:none;z-index:1000;"></div>
          </div>
        </div>

        <div>
          <div class="label">‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á (‡∏ö‡∏≤‡∏ó)</div>
          <input id="shipping" type="number" min="0" step="1" placeholder="‡πÉ‡∏™‡πà‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏™‡πà ‡∏ø">
        </div>

        <div style="grid-column:1/-1">
          <div class="label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á</div>
          <textarea id="address" placeholder="‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà ‡∏´‡∏£‡∏∑‡∏≠ ‡∏à‡∏∏‡∏î‡∏ô‡∏±‡∏î‡∏£‡∏±‡∏ö"></textarea>
        </div>
      </div>
    </div>

    <div class="group">
      <div class="label">‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</div>
      <div class="product-list" id="products"></div>
    </div>
  </div>

  <div class="sheet">
    <div class="pill">‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: <span id="grandTotal">0‡∏ø</span></div>
    <button id="buildBtn" class="primary">‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
  </div>

  <div id="toast" class="toast">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß</div>

  <div id="modal" class="modal" aria-hidden="true">
    <div class="panel">
      <h2>‡∏™‡∏£‡∏∏‡∏õ‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå</h2>
      <textarea id="output" readonly></textarea>
      <div class="actions">
        <button class="btn" id="copyBtn">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
        <button class="btn" id="closeBtn">‡∏õ‡∏¥‡∏î</button>
        <button class="btn danger" id="resetBtn">‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded',()=>{
  if('serviceWorker' in navigator){navigator.serviceWorker.register('./sw.js').catch(()=>{});}

  const productsEl=document.getElementById('products');
  const shippingEl=document.getElementById('shipping');
  const grandEl=document.getElementById('grandTotal');
  const toast=document.getElementById('toast');
  const modal=document.getElementById('modal');
  const output=document.getElementById('output');

  // ===== ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ (‡∏£‡∏ß‡∏°‡πÄ‡∏£‡∏ó‡∏û‡∏¥‡πÄ‡∏®‡∏©) =====
  const PRODUCTS=[
    {name:'‡∏ù‡∏£‡∏±‡πà‡∏á‡πÄ‡∏•‡πá‡∏Å',price:39},
    {name:'‡∏ù‡∏£‡∏±‡πà‡∏á‡πÉ‡∏´‡∏ç‡πà',price:69},
    {name:'‡∏ú‡∏•‡πÑ‡∏°‡πâ‡∏£‡∏ß‡∏°', price:35},
    {name:'‡∏ú‡∏•‡πÑ‡∏°‡πâ‡∏£‡∏ß‡∏° (‡∏£‡∏≤‡∏Ñ‡∏≤‡πÇ‡∏õ‡∏£‡∏Ø)', price:100},
    {name:'‡∏Å‡∏£‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡∏ó‡∏£‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á',price:69},
    {name:'‡∏Å‡∏£‡∏∞‡∏ó‡πâ‡∏≠‡∏ô‡∏ô‡πâ‡∏≥‡∏õ‡∏•‡∏≤‡∏´‡∏ß‡∏≤‡∏ô',price:69},
    {name:'‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á‡∏ó‡∏£‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á',price:69},
    {name:'‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á‡∏ô‡πâ‡∏≥‡∏õ‡∏•‡∏≤‡∏´‡∏ß‡∏≤‡∏ô',price:69, opts:[{label:'‡∏Å‡∏∏‡πâ‡∏á‡πÅ‡∏´‡πâ‡∏á',price:69},{label:'‡∏õ‡∏•‡∏≤‡∏õ‡πà‡∏ô',price:69}]},
    {name:'‡∏°‡∏∞‡∏°‡πà‡∏ß‡∏á', price:40},
    {name:'‡∏ô‡πâ‡∏≥‡∏õ‡∏•‡∏≤‡∏´‡∏ß‡∏≤‡∏ô (‡∏Å‡∏∏‡πâ‡∏á‡πÅ‡∏´‡πâ‡∏á)', price:29},
    {name:'‡∏ô‡πâ‡∏≥‡∏õ‡∏•‡∏≤‡∏´‡∏ß‡∏≤‡∏ô (‡∏õ‡∏•‡∏≤‡∏õ‡πà‡∏ô)', price:29},
    {name:'‡∏™‡πâ‡∏°‡πÑ‡∏ï‡πâ‡∏´‡∏ß‡∏±‡∏ô‡πÄ‡∏•‡πá‡∏Å',price:49},
    {name:'‡∏™‡πâ‡∏°‡πÑ‡∏ï‡πâ‡∏´‡∏ß‡∏±‡∏ô‡πÉ‡∏´‡∏ç‡πà',price:89},
    {name:'‡∏™‡πâ‡∏°‡∏Æ‡∏±‡∏ô‡∏ô‡∏µ‡πà‡πÄ‡∏•‡πá‡∏Å',price:59},
    {name:'‡∏™‡πâ‡∏°‡∏Æ‡∏±‡∏ô‡∏ô‡∏µ‡πà‡πÉ‡∏´‡∏ç‡πà',price:99},
    {name:'‡∏ô‡πâ‡∏≥‡πÅ‡∏Ç‡πá‡∏á', price:5},

    // ===== ‡πÄ‡∏£‡∏ó‡∏û‡∏¥‡πÄ‡∏®‡∏© =====
    {section:'‡πÄ‡∏£‡∏ó‡∏û‡∏¥‡πÄ‡∏®‡∏©'},
    {name:'‡∏ù‡∏£‡∏±‡πà‡∏á‡πÄ‡∏•‡πá‡∏Å', price:33, special:true},
    {name:'‡∏ù‡∏£‡∏±‡πà‡∏á‡πÄ‡∏•‡πá‡∏Å', price:35, special:true},
    {name:'‡∏ù‡∏£‡∏±‡πà‡∏á‡πÉ‡∏´‡∏ç‡πà', price:65, special:true},  // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ï‡∏≤‡∏°‡∏Ñ‡∏≥‡∏Ç‡∏≠
  ];

  // ‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏ï‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢ ‡∏ø
  const baht = n => `${Number(n).toLocaleString('th-TH')}‡∏ø`;

  // ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡∏ß/‡∏î/‡∏õ (‡∏û.‡∏®.)
  function formatThaiDateShortBE(iso){
    if(!iso) return '';
    const d=new Date(iso+'T00:00:00');
    const dd=String(d.getDate()).padStart(2,'0');
    const mm=String(d.getMonth()+1).padStart(2,'0');
    const yyyyBE=d.getFullYear()+543;
    return `${dd}/${mm}/${yyyyBE}`;
  }

  function showToast(msg){ if(msg) toast.textContent=msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'),1200); }

  function recalc(){
    let itemsTotal=0;
    document.querySelectorAll('.product').forEach(row=>{
      let subRow=0;
      const main=row.querySelector('input[data-price][data-name]:not([data-opt])');
      if(main){ subRow += (Number(main.value)||0) * Number(main.dataset.price); }
      row.querySelectorAll('input[data-opt]').forEach(inp=>{
        subRow += (Number(inp.value)||0) * Number(inp.dataset.price);
      });
      row.querySelector('.subtotal').textContent=baht(subRow);
      itemsTotal+=subRow;
    });
    const shipping=Math.max(0,Number(shippingEl.value)||0);
    grandEl.textContent=baht(itemsTotal+shipping);
  }

  function makeStepInput(attrs){
    const extra = attrs.opt ? ` data-opt="${attrs.opt}"` : '';
    return `
      <div class="step">
        <button type="button" class="dec" aria-label="‡∏•‡∏î‡∏à‡∏≥‡∏ô‡∏ß‡∏ô">‚àí</button>
        <input type="number" min="0" step="1" value="0" data-price="${attrs.price}" data-name="${attrs.name}"${extra}>
        <button type="button" class="inc" aria-label="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≥‡∏ô‡∏ß‡∏ô">+</button>
      </div>`;
  }

  function bindStep(container){
    const dec=container.querySelector('.dec');
       const inc=container.querySelector('.inc');
    const inp=container.querySelector('input[type="number"]');
    dec.addEventListener('click',()=>{inp.value=Math.max(0,(Number(inp.value)||0)-1);recalc();});
    inc.addEventListener('click',()=>{inp.value=(Number(inp.value)||0)+1;recalc();});
    inp.addEventListener('input',recalc,{passive:true});
  }

  function renderProducts(){
    productsEl.innerHTML='';

    let specialWrap=null; // container ‡πÄ‡∏£‡∏ó‡∏û‡∏¥‡πÄ‡∏®‡∏©
    let specialHeader=null;

    PRODUCTS.forEach(p=>{
      // ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏£‡∏ó‡∏û‡∏¥‡πÄ‡∏®‡∏©‡πÅ‡∏ö‡∏ö‡∏û‡∏±‡∏ö/‡∏Ç‡∏¢‡∏≤‡∏¢
      if(p.section){
        specialHeader=document.createElement('button');
        specialHeader.type='button';
        specialHeader.className='special-toggle special-collapsed';
        specialHeader.setAttribute('aria-expanded','false');
        specialHeader.setAttribute('aria-controls','special-wrap');
        specialHeader.innerHTML=`<span class="title">üöö ‡πÄ‡∏£‡∏ó‡∏û‡∏¥‡πÄ‡∏®‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏±‡∏ö‡∏´‡∏¥‡πâ‡∏ß</span><span class="chev">‚ñæ</span>`;
        productsEl.appendChild(specialHeader);

        specialWrap=document.createElement('div');
        specialWrap.id='special-wrap';
        specialWrap.className='special-wrap';
        productsEl.appendChild(specialWrap);

        // ‡∏û‡∏±‡∏ö/‡∏Ç‡∏¢‡∏≤‡∏¢
        specialHeader.addEventListener('click',()=>{
          const open = specialHeader.getAttribute('aria-expanded')==='true';
          specialHeader.setAttribute('aria-expanded', String(!open));
          specialHeader.classList.toggle('special-collapsed', open);
          specialWrap.style.display = open ? 'none' : 'grid';
        });
        return;
      }

      // ‡πÅ‡∏ñ‡∏ß‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤
      const row=document.createElement('div');
      row.className='product' + (p.special ? ' special' : '');

      if(p.opts){ // ‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏¢‡πà‡∏≠‡∏¢‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ß
        const optsHTML = p.opts.map(o=>`
          <div class="option-item">
            <label>${o.label}</label>
            ${makeStepInput({price:o.price,name:p.name,opt:o.label})}
          </div>
        `).join('');
        row.innerHTML=`
          <div class="name">
            ${p.name} <span class="price">${baht(p.price)}</span>
            <div class="option-group">${optsHTML}</div>
          </div>
          <div></div>
          <div class="subtotal">${baht(0)}</div>`;
        row.querySelectorAll('.option-item .step').forEach(bindStep);
      }else{
        row.innerHTML=`
          <div class="name">${p.name} <span class="price">${baht(p.price)}</span></div>
          ${makeStepInput({price:p.price,name:p.name})}
          <div class="subtotal">${baht(0)}</div>`;
        bindStep(row);
      }

      // ‡πÉ‡∏™‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á
      if(p.special && specialWrap){
        specialWrap.appendChild(row);
      }else{
        productsEl.appendChild(row);
      }
    });

    if(specialWrap){
      specialWrap.style.gridTemplateColumns='unset';
      specialWrap.style.gap='10px';
    }
  }

  function openModal(){ modal.classList.add('open'); modal.setAttribute('aria-hidden','false'); }
  function closeModal(){ modal.classList.remove('open'); modal.setAttribute('aria-hidden','true'); }

  function buildSummary(){
    const date=formatThaiDateShortBE(document.getElementById('date').value);
    const name=(document.getElementById('name').value||'').trim();
    const phone=(document.getElementById('phone').value||'').trim();
    const shipping=Math.max(0,Number(shippingEl.value)||0);
    const address=(document.getElementById('address').value||'').trim();

    const lines=[]; let itemsTotal=0;

    document.querySelectorAll('#products input[data-price]').forEach(inp=>{
      const qty=Number(inp.value)||0;
      if(qty>0){
        const nm   = inp.dataset.name;
        const opt  = inp.dataset.opt ? ` (${inp.dataset.opt})` : '';
        const price= Number(inp.dataset.price);
        const sub  = price * qty;
        itemsTotal += sub;
        lines.push(`   ‚Ä¢ ${nm}${opt} x${qty} (${baht(sub)})`);
      }
    });

    if(!lines.length){ showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤'); return; }

    const total=itemsTotal+shipping;
    const text=[
      `${date || '-'}`,
      `‡∏≠‡∏≠‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Ñ‡∏∏‡∏ì ${name || '-'}`,
      `(${phone || '-'})`,
      ...lines,
      `‡∏Ñ‡πà‡∏≤‡∏™‡πà‡∏á : ${baht(shipping)}`,
      `*** ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° ${baht(total)} ***`,
      `üìç${address || '-'}`,
    ].join('\n');

    output.value=text;
    openModal();
  }

  // Init + bind
  renderProducts(); recalc();
  document.getElementById('buildBtn').addEventListener('click',buildSummary);
  document.getElementById('closeBtn').addEventListener('click',closeModal);

  // ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å
  document.getElementById('copyBtn').addEventListener('click', async ()=>{
    const text = output.value || '';
    if (!text.trim()) return;
    showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
    try { await navigator.clipboard.writeText(text); }
    catch(_) { output.select(); document.execCommand('copy'); window.getSelection().removeAllRanges(); }
  });

  // ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°
  document.getElementById('resetBtn').addEventListener('click',()=>{
    document.querySelectorAll('input[type="text"],input[type="tel"],input[type="date"]').forEach(el=>{ el.value=''; });
    document.getElementById('address').value='';
    document.querySelectorAll('#products input[type="number"]').forEach(inp=>{ inp.value=0; });
    shippingEl.value='';
    recalc(); closeModal(); showToast('‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡πâ‡∏ß');
  });

  // ‡∏õ‡∏¥‡∏î‡πÇ‡∏°‡∏î‡∏±‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÅ‡∏ï‡∏∞‡∏ô‡∏≠‡∏Å‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô
  modal.addEventListener('click',e=>{ if(e.target===modal) closeModal(); });

// ===== Customer Search (Preload once, then local filter) =====
const phoneEl = document.getElementById('phone');
const nameEl  = document.getElementById('name');
const addrEl  = document.getElementById('address');
const suggestBox = document.getElementById('phone-suggestions');

// ‡πÉ‡∏ä‡πâ URL Web App ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡∏•‡∏á‡∏ó‡πâ‡∏≤‡∏¢ /exec)
const API_URL = 'https://script.google.com/macros/s/AKfycbzUS_chJeI9ysyWQFQpdsAaFrPI5qNVrZX9DBrRvqQ-JsFcAI1X6DbJc1fzHE3d7G7lUw/exec';

const digitsOnly = s => (s || '').replace(/\D/g, '');
function normalizePhoneLocal(s){
  let d = digitsOnly(s);
  if (d.startsWith('66')) d = '0' + d.slice(2);
  if (d.length > 10) d = d.slice(-10);
  return d;
}

// --- preload ---
let CUSTOMER_DATA = null; // [{name,phone,address}, ...]
let preloadPromise = null;

async function ensureCustomersLoaded() {
  if (CUSTOMER_DATA) return CUSTOMER_DATA;
  if (preloadPromise) return preloadPromise;

  // ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ localStorage ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡πà‡∏ß‡∏á‡∏£‡∏≠‡∏ö‡∏ï‡πà‡∏≠‡πÑ‡∏õ (optional)
  try {
    const cached = localStorage.getItem('customers_cache_v2');
    if (cached) {
      const parsed = JSON.parse(cached);
      if (Array.isArray(parsed) && parsed.length) {
        CUSTOMER_DATA = parsed;
        return CUSTOMER_DATA;
      }
    }
  } catch(_) {}

  preloadPromise = fetch(`${API_URL}?all=1`, { cache:'no-store' })
    .then(r => r.ok ? r.json() : null)
    .then(j => {
      if (j && j.ok && Array.isArray(j.data)) {
        // normalize phone ‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏£‡πá‡∏ß
        CUSTOMER_DATA = j.data.map(x => ({...x, phone: normalizePhoneLocal(x.phone) }));
        try { localStorage.setItem('customers_cache_v2', JSON.stringify(CUSTOMER_DATA)); } catch(_) {}
        return CUSTOMER_DATA;
      }
      return [];
    })
    .catch(()=>[])
    .finally(()=>{ preloadPromise = null; });
  return preloadPromise;
}

// --- render dropdown ---
function renderSuggestions(list){
  suggestBox.innerHTML = '';
  if (!list.length) { suggestBox.style.display='none'; return; }
  list.slice(0,30).forEach(c=>{
    const item=document.createElement('div');
    item.textContent=`${c.name} (${c.phone})`;
    item.style.padding='8px 12px';
    item.style.cursor='pointer';
    item.style.borderBottom='1px solid #eee';
    item.addEventListener('mouseenter',()=>{ item.style.background='#f5f7fa'; });
    item.addEventListener('mouseleave',()=>{ item.style.background='transparent'; });
    item.addEventListener('click',()=>{
      phoneEl.value=c.phone;
      nameEl.value=c.name;
      addrEl.value=c.address;
      suggestBox.style.display='none';
      if (typeof showToast==='function') showToast('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß');
    });
    suggestBox.appendChild(item);
  });
  suggestBox.style.display='block';
}

// --- search local ---
async function onPhoneChanged(){
  const q = normalizePhoneLocal(phoneEl.value);
  if (q.length < 3) { suggestBox.style.display='none'; return; }

  const rows = await ensureCustomersLoaded();
  if (!rows || !rows.length) { suggestBox.style.display='none'; return; }

  // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö includes (‡∏´‡∏£‡∏∑‡∏≠ startsWith ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£)
  const matches = rows.filter(r => r.phone.includes(q));
  renderSuggestions(matches);
}

// input handler
phoneEl.addEventListener('input', e=>{
  e.target.value = digitsOnly(e.target.value);
  // ‡∏¢‡∏¥‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ (local filter ‡πÄ‡∏£‡πá‡∏ß‡∏°‡∏≤‡∏Å) ‚Äî ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡∏≠‡∏¢‡∏≤‡∏Å‡∏Å‡∏±‡∏ô‡∏™‡∏±‡πà‡∏ô ‡πÉ‡∏™‡πà debounce 50‚Äì100ms ‡πÑ‡∏î‡πâ
  onPhoneChanged();
}, { passive:true });

// ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡∏ï‡∏≠‡∏ô focus ‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏ö‡∏≠‡∏£‡πå ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡πà‡∏≠‡∏ô‡∏î‡∏µ‡πÄ‡∏•‡∏¢‡πå‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
phoneEl.addEventListener('focus', () => { ensureCustomersLoaded(); });

// ‡∏õ‡∏¥‡∏î dropdown ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å‡∏Å‡∏£‡∏≠‡∏ö
document.addEventListener('click',e=>{
  if(!suggestBox.contains(e.target) && e.target!==phoneEl){
    suggestBox.style.display='none';
  }
});
});
</script>
</body>
</html>
